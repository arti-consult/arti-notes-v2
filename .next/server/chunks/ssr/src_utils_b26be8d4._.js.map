{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 7, "column": 0}, "map": {"version":3,"sources":["file://D%3A/breyholtz%20holding/arti-notes/arti-notes-v2/src/utils/supabase/server.ts"],"sourcesContent":["import { createBrowserClient } from \"@supabase/ssr\";\r\n\r\nexport function createClient() {\r\n  return createBrowserClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\r\n  );\r\n}\r\n"],"names":[],"mappings":";;;AAAA;AAAA;;AAEO,SAAS;IACd,OAAO,CAAA,GAAA,0KAAA,CAAA,sBAAmB,AAAD;AAI3B","debugId":null}},
    {"offset": {"line": 22, "column": 0}, "map": {"version":3,"sources":["file://D%3A/breyholtz%20holding/arti-notes/arti-notes-v2/src/utils/tracking/server.ts"],"sourcesContent":["// src/utils/tracking/server.ts\r\nimport { createClient } from \"@/utils/supabase/server\";\r\nimport { cookies } from \"next/headers\";\r\nimport { UTMParams } from \"./utm\";\r\n\r\n// Cookie names\r\nexport const UTM_COOKIE_NAME = \"arti_utm_data\";\r\nexport const VISIT_COOKIE_NAME = \"arti_visit_data\";\r\nexport const ANONYMOUS_ID_COOKIE = \"arti_anonymous_id\";\r\n\r\n// Cookie settings\r\nconst COOKIE_OPTIONS = {\r\n  expires: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days\r\n  path: \"/\",\r\n  sameSite: \"lax\" as const,\r\n  secure: process.env.NODE_ENV === \"production\",\r\n};\r\n\r\n/**\r\n * Link anonymous tracking data to a user after they sign up or log in\r\n */\r\nexport async function linkTrackingDataToUser(userId: string): Promise<void> {\r\n  try {\r\n    const supabase = await createClient();\r\n    const cookieStore = await cookies();\r\n\r\n    // Get anonymous ID from cookies\r\n    const anonymousId = cookieStore.get(ANONYMOUS_ID_COOKIE)?.value;\r\n\r\n    if (!anonymousId) {\r\n      return;\r\n    }\r\n\r\n    // Update all tracking data records with this anonymous ID to link to the user\r\n    await supabase\r\n      .from(\"tracking_data\")\r\n      .update({ user_id: userId })\r\n      .eq(\"anonymous_id\", anonymousId)\r\n      .is(\"user_id\", null);\r\n  } catch (error) {\r\n    console.error(\"Error linking tracking data to user:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Get the latest tracking data for a user\r\n */\r\nexport async function getUserTrackingData(userId: string) {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    const { data, error } = await supabase\r\n      .from(\"tracking_data\")\r\n      .select(\"*\")\r\n      .eq(\"user_id\", userId)\r\n      .order(\"created_at\", { ascending: false })\r\n      .limit(1)\r\n      .single();\r\n\r\n    if (error) {\r\n      console.error(\"Error getting user tracking data:\", error);\r\n      return null;\r\n    }\r\n\r\n    return data;\r\n  } catch (error) {\r\n    console.error(\"Error getting user tracking data:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Save UTM data during onboarding\r\n */\r\nexport async function saveUTMDataDuringOnboarding(\r\n  userId: string,\r\n  onboardingId: string\r\n): Promise<void> {\r\n  try {\r\n    const supabase = await createClient();\r\n\r\n    // Get latest tracking data for the user\r\n    const trackingData = await getUserTrackingData(userId);\r\n\r\n    if (!trackingData) return;\r\n\r\n    // Update onboarding record with UTM data\r\n    await supabase\r\n      .from(\"user_onboarding\")\r\n      .update({\r\n        tracking_data_id: trackingData.id,\r\n        utm_source: trackingData.utm_source,\r\n        utm_medium: trackingData.utm_medium,\r\n        utm_campaign: trackingData.utm_campaign,\r\n        referrer: trackingData.referrer,\r\n      })\r\n      .eq(\"id\", onboardingId);\r\n  } catch (error) {\r\n    console.error(\"Error saving UTM data during onboarding:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Get UTM data from cookie on the server\r\n */\r\nexport async function getServerUTMData(): Promise<UTMParams | null> {\r\n  try {\r\n    const cookieStore = await cookies();\r\n    const utmData = cookieStore.get(UTM_COOKIE_NAME);\r\n    return utmData ? JSON.parse(utmData.value) : null;\r\n  } catch (error) {\r\n    console.error(\"Error getting server UTM data:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get visit data from cookie on the server\r\n */\r\nexport async function getServerVisitData(): Promise<{\r\n  first_visit?: string;\r\n  referrer?: string;\r\n  landing_page?: string;\r\n} | null> {\r\n  try {\r\n    const cookieStore = await cookies();\r\n    const visitData = cookieStore.get(VISIT_COOKIE_NAME);\r\n    return visitData ? JSON.parse(visitData.value) : null;\r\n  } catch (error) {\r\n    console.error(\"Error getting server visit data:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get anonymous ID from cookie on the server\r\n */\r\nexport async function getServerAnonymousId(): Promise<string | null> {\r\n  try {\r\n    const cookieStore = await cookies();\r\n    const anonymousId = cookieStore.get(ANONYMOUS_ID_COOKIE);\r\n    return anonymousId ? anonymousId.value : null;\r\n  } catch (error) {\r\n    console.error(\"Error getting server anonymous ID:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * Get all tracking data from cookies on the server\r\n */\r\nexport async function getServerTrackingData(): Promise<{\r\n  utmData: UTMParams | null;\r\n  visitData: {\r\n    first_visit?: string;\r\n    referrer?: string;\r\n    landing_page?: string;\r\n  } | null;\r\n  anonymousId: string | null;\r\n}> {\r\n  const [utmData, visitData, anonymousId] = await Promise.all([\r\n    getServerUTMData(),\r\n    getServerVisitData(),\r\n    getServerAnonymousId(),\r\n  ]);\r\n\r\n  return {\r\n    utmData,\r\n    visitData,\r\n    anonymousId,\r\n  };\r\n}\r\n\r\n/**\r\n * Set UTM data in cookie on the server\r\n */\r\nexport async function setServerUTMData(data: UTMParams): Promise<void> {\r\n  try {\r\n    const cookieStore = await cookies();\r\n    cookieStore.set(UTM_COOKIE_NAME, JSON.stringify(data), COOKIE_OPTIONS);\r\n  } catch (error) {\r\n    console.error(\"Error setting server UTM data:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Set visit data in cookie on the server\r\n */\r\nexport async function setServerVisitData(data: {\r\n  first_visit: string;\r\n  referrer?: string;\r\n  landing_page: string;\r\n}): Promise<void> {\r\n  try {\r\n    const cookieStore = await cookies();\r\n    cookieStore.set(VISIT_COOKIE_NAME, JSON.stringify(data), COOKIE_OPTIONS);\r\n  } catch (error) {\r\n    console.error(\"Error setting server visit data:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Set anonymous ID in cookie on the server\r\n */\r\nexport async function setServerAnonymousId(id: string): Promise<void> {\r\n  try {\r\n    const cookieStore = await cookies();\r\n    cookieStore.set(ANONYMOUS_ID_COOKIE, id, {\r\n      ...COOKIE_OPTIONS,\r\n      expires: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000), // 1 year\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Error setting server anonymous ID:\", error);\r\n  }\r\n}\r\n\r\n/**\r\n * Clear all tracking cookies on the server\r\n */\r\nexport async function clearServerTrackingCookies(): Promise<void> {\r\n  try {\r\n    const cookieStore = await cookies();\r\n    cookieStore.delete(UTM_COOKIE_NAME);\r\n    cookieStore.delete(VISIT_COOKIE_NAME);\r\n    cookieStore.delete(ANONYMOUS_ID_COOKIE);\r\n  } catch (error) {\r\n    console.error(\"Error clearing server tracking cookies:\", error);\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}