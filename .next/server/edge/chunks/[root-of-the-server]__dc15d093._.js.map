{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 23, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/src/middleware.ts"],"sourcesContent":["// src/middleware.ts\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport { createServerClient } from \"@supabase/ssr\";\r\n\r\n// Define protection rules for routes\r\nconst protectedRoutes = [\r\n  {\r\n    path: \"/dashboard\",\r\n    requireAuth: true,\r\n    minTier: \"free\", // \"free\", \"basic\", \"premium\", or \"admin\"\r\n  },\r\n  {\r\n    path: \"/admin\",\r\n    requireAuth: true,\r\n    minTier: \"admin\",\r\n  },\r\n  {\r\n    path: \"/settings\",\r\n    requireAuth: true,\r\n    minTier: \"free\",\r\n  },\r\n  {\r\n    path: \"/meetings\",\r\n    requireAuth: true,\r\n    minTier: \"free\",\r\n  },\r\n  {\r\n    path: \"/api/recordings\",\r\n    requireAuth: true,\r\n    minTier: \"free\",\r\n  },\r\n];\r\n\r\nexport async function middleware(request: NextRequest) {\r\n  let response = NextResponse.next({\r\n    request: {\r\n      headers: request.headers,\r\n    },\r\n  });\r\n\r\n  const supabase = createServerClient(\r\n    process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\r\n    {\r\n      cookies: {\r\n        getAll() {\r\n          return request.cookies.getAll();\r\n        },\r\n        setAll(cookiesToSet) {\r\n          cookiesToSet.forEach(({ name, value, options }) =>\r\n            request.cookies.set(name, value)\r\n          );\r\n          response = NextResponse.next({\r\n            request: {\r\n              headers: request.headers,\r\n            },\r\n          });\r\n          cookiesToSet.forEach(({ name, value, options }) =>\r\n            response.cookies.set(name, value, options)\r\n          );\r\n        },\r\n      },\r\n    }\r\n  );\r\n\r\n  const {\r\n    data: { session },\r\n  } = await supabase.auth.getSession();\r\n\r\n  const pathname = request.nextUrl.pathname;\r\n\r\n  // Check if the path is protected\r\n  const protectedRoute = protectedRoutes.find((route) =>\r\n    pathname.startsWith(route.path)\r\n  );\r\n\r\n  // If route is protected and user is not authenticated, redirect to login\r\n  if (protectedRoute?.requireAuth && !session) {\r\n    const redirectUrl = new URL(\"/login\", request.url);\r\n    redirectUrl.searchParams.set(\"redirect\", pathname);\r\n    return NextResponse.redirect(redirectUrl);\r\n  }\r\n\r\n  // If authenticated and route requires a minimum tier\r\n  if (session && protectedRoute?.minTier) {\r\n    // Skip tier check for admin paths if the path itself requires admin access\r\n    if (pathname.startsWith(\"/admin\") && protectedRoute.minTier === \"admin\") {\r\n      // Check if user is admin\r\n      const { data } = await supabase\r\n        .from(\"user_roles\")\r\n        .select(\r\n          `\r\n          roles!inner (\r\n            name\r\n          )\r\n        `\r\n        )\r\n        .eq(\"user_id\", session.user.id)\r\n        .eq(\"roles.name\", \"admin\");\r\n\r\n      // If not admin, redirect to dashboard\r\n      if (!data || data.length === 0) {\r\n        return NextResponse.redirect(new URL(\"/dashboard\", request.url));\r\n      }\r\n    } else if (protectedRoute.minTier !== \"free\") {\r\n      // For non-admin paths that require a minimum tier other than free\r\n\r\n      // Function to get tier level\r\n      const getTierLevel = (tier: string): number => {\r\n        const levels = { free: 0, basic: 1, premium: 2, admin: 3 };\r\n        return levels[tier as keyof typeof levels] || 0;\r\n      };\r\n\r\n      // Get user roles\r\n      const { data: userRoles } = await supabase\r\n        .from(\"user_roles\")\r\n        .select(\r\n          `\r\n          roles!inner (\r\n            name\r\n          )\r\n        `\r\n        )\r\n        .eq(\"user_id\", session.user.id);\r\n\r\n      // Check if user has the required tier\r\n      const minTierLevel = getTierLevel(protectedRoute.minTier);\r\n      const userTiers =\r\n        userRoles?.map((ur) => getTierLevel((ur.roles as any).name)) || [];\r\n      const maxUserTier = Math.max(...userTiers, 0);\r\n\r\n      // If user's max tier is less than required, redirect\r\n      if (maxUserTier < minTierLevel) {\r\n        // Redirect to pricing page if tier is insufficient\r\n        return NextResponse.redirect(\r\n          new URL(\"/pricing?upgrade=true\", request.url)\r\n        );\r\n      }\r\n    }\r\n  }\r\n\r\n  // Special handling for auth pages when user is already logged in\r\n  if (\r\n    session &&\r\n    (pathname === \"/login\" || pathname === \"/register\" || pathname === \"/\")\r\n  ) {\r\n    return NextResponse.redirect(new URL(\"/dashboard\", request.url));\r\n  }\r\n\r\n  return response;\r\n}\r\n\r\nexport const config = {\r\n  matcher: [\r\n    /*\r\n     * Match all request paths except for:\r\n     * - _next/static (static files)\r\n     * - _next/image (image optimization files)\r\n     * - favicon.ico (favicon file)\r\n     * - public files (assets)\r\n     * - api/webhooks (webhook endpoints)\r\n     */\r\n    \"/((?!_next/static|_next/image|favicon.ico|api/webhooks|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)\",\r\n  ],\r\n};\r\n"],"names":[],"mappings":"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"}}]
}